function toggleColor(element) {
  // Kiá»ƒm tra náº¿u pháº§n tá»­ Ä‘Ã£ cÃ³ class 'active' thÃ¬ bá» Ä‘i, náº¿u chÆ°a cÃ³ thÃ¬ thÃªm vÃ o
  element.classList.toggle("active");
}
function toggleActive(button) {
  button.classList.toggle("active");
}
document.addEventListener("DOMContentLoaded", function () {
  const modesContainer = document.querySelector(".modes");

  modesContainer.addEventListener("click", function (event) {
    const button = event.target.closest("button");

    if (!button) return; // Náº¿u khÃ´ng báº¥m vÃ o nÃºt thÃ¬ bá» qua

    // Xá»­ lÃ½ riÃªng cho nÃºt "In Bed"
    if (
      button.classList.contains("locked") ||
      button.classList.contains("unlocked")
    ) {
      if (button.classList.contains("unlocked")) {
        // Náº¿u Ä‘Ã£ má»Ÿ khÃ³a, click láº§n ná»¯a sáº½ khÃ³a láº¡i
        button.classList.remove("unlocked", "active");
        button.classList.add("locked");

        // ThÃªm láº¡i icon khÃ³a
        const lockIcon = document.createElement("i");
        lockIcon.classList.add("fa-solid", "fa-lock", "lock-icon");
        button.appendChild(lockIcon);
      } else {
        // Náº¿u Ä‘ang khÃ³a, má»Ÿ khÃ³a vÃ  Ä‘á»•i mÃ u
        button.classList.remove("locked");
        button.classList.add("unlocked", "active");

        // XÃ³a icon khÃ³a
        const lockIcon = button.querySelector(".lock-icon");
        if (lockIcon) lockIcon.remove();
      }
      return;
    }

    // Toggle class "active" cho táº¥t cáº£ cÃ¡c nÃºt khÃ¡c
    button.classList.toggle("active");
  });
});
document.addEventListener("DOMContentLoaded", function () {
  const securityLocks = document.querySelectorAll(".security .lock");

  securityLocks.forEach((lock) => {
    lock.addEventListener("click", function () {
      if (this.classList.contains("locked")) {
        // Má»Ÿ khÃ³a
        this.classList.remove("locked");
        this.classList.add("unlocked");
        this.innerHTML = `<i class="fa-solid fa-unlock"></i> <span>${this.innerText.replace(
          "Locked",
          "Unlocked"
        )}</span>`;
      } else {
        // KhÃ³a láº¡i
        this.classList.remove("unlocked");
        this.classList.add("locked");
        this.innerHTML = `<i class="fa-solid fa-lock"></i> <span>${this.innerText.replace(
          "Unlocked",
          "Locked"
        )}</span>`;
      }
    });
  });
});
// Hiá»ƒn thá»‹ giá» Viá»‡t Nam (mÃºi giá» HÃ  Ná»™i)
function updateTime() {
  const now = new Date();
  const options = {
    timeZone: "Asia/Bangkok",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
  };
  const timeString = now.toLocaleTimeString("vi-VN", options);
  document.getElementById("time-box").textContent = timeString;
}
setInterval(updateTime, 1000);
updateTime();

// Láº¥y dá»¯ liá»‡u thá»i tiáº¿t HÃ  Ná»™i tá»« OpenWeatherMap
async function fetchWeather() {
  const apiKey = "c87db1d2580dc72154847239c6d6e75b"; // Thay báº±ng API key cá»§a báº¡n
  const city = "Hanoi";
  const url = `https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey}&units=metric&lang=vi`;

  try {
    const response = await fetch(url);
    const data = await response.json();

    if (data.cod === 200) {
      const temperature = data.main.temp;
      document.getElementById("temperature").textContent = `${temperature}Â°C`;
    } else {
      document.getElementById("temperature").textContent = "--Â°C";
    }
  } catch (error) {
    console.error("Lá»—i khi láº¥y dá»¯ liá»‡u thá»i tiáº¿t:", error);
    document.getElementById("temperature").textContent = "--Â°C";
  }
}
fetchWeather();

const img = document.getElementById("esp32cam-stream");

// âœ… Chá»‰ sá»­ dá»¥ng má»™t Ä‘á»‹a chá»‰ IP duy nháº¥t
const streamURL = "http://192.168.137.200:81/stream"; 

function updateStream() {
  img.src = streamURL + "?t=" + new Date().getTime(); // NgÄƒn trÃ¬nh duyá»‡t lÆ°u cache áº£nh
}

// ðŸ”¹ Xá»­ lÃ½ lá»—i khi khÃ´ng thá»ƒ táº£i áº£nh tá»« ESP32-CAM
img.onerror = function () {
  // console.error("âŒ KhÃ´ng thá»ƒ káº¿t ná»‘i ESP32-CAM. Kiá»ƒm tra láº¡i thiáº¿t bá»‹!");

  // Hiá»ƒn thá»‹ áº£nh lá»—i
  img.src = "error-image.png"; 

  // Thá»­ káº¿t ná»‘i láº¡i sau 3 giÃ¢y
  setTimeout(updateStream, 3000);
};

// ðŸ”¹ Cáº­p nháº­t hÃ¬nh áº£nh má»›i má»—i giÃ¢y
setInterval(updateStream, 1000);

// ðŸ”¹ Táº£i áº£nh láº§n Ä‘áº§u tiÃªn khi trang má»Ÿ
updateStream();


let ESP32_IP = "http://192.168.137.50"; // Äá»‹a chá»‰ IP cá»§a ESP32

// âœ… HÃ m cáº­p nháº­t tráº¡ng thÃ¡i tá»« ESP32
function updateStatus() {
  fetch(`${ESP32_IP}/status`)
    .then((response) => response.json())
    .then((data) => {
      Object.keys(data).forEach((device) => {
        let button = document.getElementById(`toggle-${device}`);
        if (button) {
          if (data[device] === "ON") {
            button.classList.add("active");
          } else {
            button.classList.remove("active");
          }
        }
      });
    })
    .catch((error) =>
      console.error("[ERROR] KhÃ´ng thá»ƒ láº¥y tráº¡ng thÃ¡i tá»« ESP32:", error)
    );
}

// âœ… HÃ m gá»­i yÃªu cáº§u báº­t/táº¯t thiáº¿t bá»‹
function toggleDevice(device) {
  fetch(`${ESP32_IP}/toggle/${device}`)
    .then(() => updateStatus())
    .catch((error) => console.error("[ERROR] KhÃ´ng thá»ƒ gá»­i yÃªu cáº§u:", error));
}

// âœ… Cáº­p nháº­t tráº¡ng thÃ¡i má»—i 2 giÃ¢y
setInterval(updateStatus, 2000);

// âœ… GÃ¡n sá»± kiá»‡n click vÃ o cÃ¡c nÃºt thiáº¿t bá»‹
document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll(".device").forEach((button) => {
    button.addEventListener("click", () => toggleDevice(button.dataset.device));
  });
  updateStatus();
});

// ðŸ”„ HÃ m cáº­p nháº­t dá»¯ liá»‡u tá»« API
function updateActivityLog() {
  fetch("http://192.168.137.88/api/get_sensors_data.php")
    .then((response) => response.json())
    .then((data) => {
      let activityList = document.querySelector(".activities ul");
      activityList.innerHTML = ""; // XÃ³a dá»¯ liá»‡u cÅ© trÆ°á»›c khi cáº­p nháº­t

      // ðŸŸ¢ Kiá»ƒm tra náº¿u cÃ³ logs
      if (data.logs && data.logs.length > 0) {
        data.logs.forEach((log) => {
          let timeAgo = getTimeAgo(log.timestamp);
          let icon = getIcon(log.activity);

          let listItem = document.createElement("li");
          listItem.innerHTML = `${icon} ${log.device_name} - ${log.activity} (${log.status}) <span>${timeAgo}</span>`;
          activityList.appendChild(listItem);
        });
      } else {
        activityList.innerHTML = "<li>ðŸ“Œ ChÆ°a cÃ³ dá»¯ liá»‡u</li>";
      }

      // Sau khi cáº­p nháº­t logs, cáº­p nháº­t luÃ´n nhiá»‡t Ä‘á»™ & Ä‘á»™ áº©m
      if (data.sensors && data.sensors.length > 0) {
        updateSensorStatus(data.sensors);
      }
    })
    .catch((error) => console.error("âŒ Lá»—i táº£i dá»¯ liá»‡u:", error));
}

// âœ… Cáº­p nháº­t Nhiá»‡t Ä‘á»™ & Äá»™ áº©m lÃªn `.status`
function updateSensorStatus(sensors) {
  sensors.forEach((sensor) => {
    let roomDiv = document.querySelector(
      `.room[data-room="${sensor.location}"]`
    );
    if (roomDiv) {
      roomDiv.querySelector(
        ".temperature"
      ).innerText = `${sensor.temperature}Â°F`;
      roomDiv.querySelector(".humidity").innerText = `${sensor.humidity}%`;
    }
  });
}
// ðŸ•’ HÃ m chuyá»ƒn Ä‘á»•i timestamp thÃ nh dáº¡ng "X phÃºt trÆ°á»›c"
function getTimeAgo(timestamp) {
  let timeDiff = Math.floor((new Date() - new Date(timestamp)) / 1000);
  if (timeDiff < 60) return `${timeDiff} giÃ¢y trÆ°á»›c`;
  if (timeDiff < 3600) return `${Math.floor(timeDiff / 60)} phÃºt trÆ°á»›c`;
  if (timeDiff < 86400) return `${Math.floor(timeDiff / 3600)} giá» trÆ°á»›c`;
  return `${Math.floor(timeDiff / 86400)} ngÃ y trÆ°á»›c`;
}

// ðŸ’¡ HÃ m chá»n icon tÆ°Æ¡ng á»©ng vá»›i loáº¡i hoáº¡t Ä‘á»™ng
function getIcon(activity) {
  if (activity.includes("Touch Sensor")) return "ðŸ’¡"; // Icon Ä‘Ã¨n
  if (activity.includes("Web Control")) return "ðŸŒ"; // Icon web
  if (activity.includes("Fan")) return "ðŸŒ€"; // Icon quáº¡t
  return "ðŸ”¹"; // Máº·c Ä‘á»‹nh náº¿u khÃ´ng cÃ³ icon phÃ¹ há»£p
}

// ðŸ”„ Gá»i API má»—i 5 giÃ¢y Ä‘á»ƒ cáº­p nháº­t log má»›i
setInterval(updateActivityLog, 5000);
updateActivityLog();
